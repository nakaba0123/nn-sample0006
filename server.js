const express = require('express');
const cors = require('cors');
const path = require("path");
const mysql = require('mysql2/promise');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

const pool = mysql.createPool({
  host: process.env.MYSQL_HOST,
  user: process.env.MYSQL_USER,
  password: process.env.MYSQL_PASSWORD,
  database: process.env.MYSQL_DATABASE,
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0,
  connectTimeout: 10000,
});

console.log("‚úÖ MySQLÊé•Á∂ö„Éó„Éº„É´„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü");

// =======================
// üè† „Ç∞„É´„Éº„Éó„Éõ„Éº„É† API
// =======================
app.get('/api/group-homes', async (req, res) => {
  try {
    const [results] = await pool.query('SELECT * FROM group_homes');
    const fixed = results.map(row => ({
      ...row,
      resident_rooms: (() => {
        try {
          const parsed = JSON.parse(row.resident_rooms || '[]');
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      })(),
    }));
    res.json(fixed);
  } catch (err) {
    console.error('DBÂèñÂæó„Ç®„É©„ÉºÂÆü„É≠„Ç∞:', err);
    res.status(500).json({ message: 'ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

app.post('/api/group-homes', async (req, res) => {
  const d = req.body;
  const sql = `
    INSERT INTO group_homes (
      property_name, unit_name, postal_code, address, 
      phone_number, common_room, resident_rooms, opening_date, created_at
    )
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
  `;
  const values = [
    d.propertyName, d.unitName, d.postalCode,
    d.address, d.phoneNumber, d.commonRoom,
    JSON.stringify(d.residentRooms), d.openingDate, d.createdAt
  ];

  try {
    await pool.query(sql, values);
    res.json({ message: 'ÁôªÈå≤„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü' });
  } catch (err) {
    console.error('ÁôªÈå≤„Ç®„É©„ÉºÂÆü„É≠„Ç∞:', err);
    res.status(500).json({ message: 'ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

app.delete('/api/group-homes/:id', async (req, res) => {
  const { id } = req.params;
  try {
    await pool.query('DELETE FROM group_homes WHERE id = ?', [id]);
    res.json({ message: 'ÂâäÈô§„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü' });
  } catch (err) {
    console.error('ÂâäÈô§„Ç®„É©„Éº:', err);
    res.status(500).json({ message: 'ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

app.put('/api/group-homes/:id', async (req, res) => {
  const { id } = req.params;
  const d = req.body;
  const sql = `
    UPDATE group_homes SET
      property_name = ?,
      unit_name = ?,
      postal_code = ?,
      address = ?,
      phone_number = ?,
      common_room = ?,
      resident_rooms = ?,
      opening_date = ?
    WHERE id = ?`;
  const values = [
    d.propertyName, d.unitName, d.postalCode, d.address,
    d.phoneNumber, d.commonRoom, JSON.stringify(d.residentRooms), d.openingDate, id
  ];
  try {
    await pool.query(sql, values);
    res.json({ message: 'Êõ¥Êñ∞„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü' });
  } catch (err) {
    console.error('Êõ¥Êñ∞„Ç®„É©„Éº:', err);
    res.status(500).json({ message: 'Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

// =======================
// üë§ Âà©Áî®ËÄÖ API
// =======================
app.post('/api/residents', async (req, res) => {
  try {
    const {
      name, nameKana, gender, birthdate,
      disabilityLevel, groupHomeId, groupHomeName, unitName,
      roomNumber, moveInDate, moveOutDate,
      status, createdAt, updatedAt
    } = req.body;

    const sql = `
      INSERT INTO residents (
        name, name_kana, gender, birthdate,
        disability_level, group_home_id, group_home_name, unit_name,
        room_number, move_in_date, move_out_date,
        status, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `;

    const values = [
      name, nameKana, gender, birthdate,
      disabilityLevel, groupHomeId, groupHomeName, unitName,
      roomNumber, moveInDate, moveOutDate,
      status, createdAt, updatedAt
    ];

    const [result] = await pool.query(sql, values);

    res.status(201).json({ message: "ÁôªÈå≤ÊàêÂäü", id: result.insertId });

  } catch (err) {
    console.error("Âà©Áî®ËÄÖÁôªÈå≤„Ç®„É©„Éº:", err);
    res.status(500).json({ message: "Âà©Áî®ËÄÖ„ÅÆÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü" });
  }
});

app.get('/api/residents', async (req, res) => {
  try {
    const [results] = await pool.query('SELECT * FROM residents ORDER BY admission_date DESC');
    res.json(results);
  } catch (err) {
    console.error('ÂèñÂæóÂ§±Êïó:', err);
    res.status(500).json({ error: 'ÂèñÂæóÂ§±Êïó' });
  }
});

app.delete('/api/residents/:id', async (req, res) => {
  const residentId = req.params.id;
  console.log('ÂâäÈô§ÂØæË±°„ÅÆID:', residentId); // ‚Üê „Åì„ÇåËøΩÂä†ÔºÅ
  try {
    const result = await pool.query('DELETE FROM residents WHERE id = ?', [residentId]);
    console.log('ÂâäÈô§ÁµêÊûú:', result); // ‚Üê „Åì„Çå„ÇÇËøΩÂä†ÔºÅ
    res.json({ message: 'ÂâäÈô§„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü' });
  } catch (err) {
    console.error('Âà©Áî®ËÄÖÂâäÈô§„Ç®„É©„Éº:', err); // ‚Üê „Ç®„É©„Éº„É≠„Ç∞„Çí„Å°„ÇÉ„Çì„Å®Âá∫„ÅôÔºÅ
    res.status(500).json({ message: 'Âà©Áî®ËÄÖ„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

app.patch('/api/residents/:id', async (req, res) => {
  const residentId = req.params.id;
  const {
    group_home_id, name, name_kana, gender, birthdate,
    disabilityHistory, room_number,
    admission_date, discharge_date, memo
  } = req.body;

  const now = new Date();

  const current = disabilityHistory.find((h) => !h.endDate);
  const disability_level = current?.disabilityLevel || null;
  const disability_start_date = current?.startDate || null;

  const dischargeDate = !discharge_date || discharge_date === "" ? null : discharge_date;

  const sql = `
    UPDATE residents SET
      group_home_id = ?, name = ?, name_kana = ?, gender = ?,
      birthdate = ?, disability_level = ?, disability_start_date = ?,
      room_number = ?, admission_date = ?, discharge_date = ?, memo = ?, updated_at = ?
    WHERE id = ?
  `;
  const values = [
    group_home_id, name, name_kana, gender, birthdate,
    disability_level, disability_start_date,
    room_number, admission_date, dischargeDate, memo, now, residentId
  ];

  try {
    console.log('[PATCH] Êõ¥Êñ∞„Éá„Éº„Çø:', values);
    await pool.query(sql, values);
    res.json({ message: 'Âà©Áî®ËÄÖ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü' });
  } catch (err) {
    console.error('Âà©Áî®ËÄÖÊõ¥Êñ∞„Ç®„É©„Éº:', err);
    res.status(500).json({ message: 'Âà©Áî®ËÄÖ„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

app.get('/api/residents/:id', async (req, res) => {
  const id = req.params.id;
  try {
    const [rows] = await pool.query('SELECT * FROM residents WHERE id = ?', [id]);
    if (rows.length === 0) return res.status(404).json({ error: 'Â±Ö‰ΩèËÄÖ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' });
    res.json(rows[0]);
  } catch (err) {
    console.error('ÂèñÂæóÂ§±Êïó:', err);
    res.status(500).json({ error: 'ÂèñÂæóÂ§±Êïó' });
  }
});

app.get('/api/usage-records', async (req, res) => {
  try {
    const [rows] = await pool.query('SELECT * FROM usage_records');
    res.json(rows);
  } catch (err) {
    console.error('üìõ usage_recordsÂèñÂæó„Ç®„É©„Éº:', err);
    res.status(500).json({ error: 'ÂÜÖÈÉ®„Çµ„Éº„Éê„Éº„Ç®„É©„Éº' });
  }
});

app.post('/api/disability_histories', async (req, res) => {
  console.log("POST /api/disability_histories „ÅåÂëº„Å∞„Çå„Åæ„Åó„ÅüÔºÅ");
  console.log("req.body:", req.body);

  const { residentId, disabilityLevel, startDate, endDate } = req.body;

  const sql = `
    INSERT INTO disability_histories
      (resident_id, disability_level, start_date, end_date)
    VALUES (?, ?, ?, ?)
  `;

  const values = [
    residentId || null,
    disabilityLevel || null,
    startDate || null,
    endDate || null
  ];

  try {
    const [result] = await pool.query(sql, values);
    res.status(201).json({ message: 'ÈöúÂÆ≥Â±•Ê≠¥„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü', id: result.insertId });
  } catch (err) {
    console.error('ÈöúÂÆ≥Â±•Ê≠¥ÁôªÈå≤„Ç®„É©„Éº:', err);
    res.status(500).json({ message: 'ÈöúÂÆ≥Â±•Ê≠¥„ÅÆÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

app.get('/api/disability_histories', async (req, res) => {
  const residentId = req.query.resident_id;

  if (!residentId) {
    return res.status(400).json({ error: "resident_id is required" });
  }

  try {
    const db = await mysql.createConnection({
      host: process.env.MYSQL_HOST,
      user: process.env.MYSQL_USER,
      password: process.env.MYSQL_PASSWORD,
      database: process.env.MYSQL_DATABASE,
    });

    const [rows] = await db.query(
      `SELECT * FROM disability_histories WHERE resident_id = ? ORDER BY start_date DESC`,
      [residentId]
    );

    res.json(rows);
  } catch (error) {
    console.error("ÈöúÂÆ≥Â±•Ê≠¥„ÅÆÂèñÂæó„Ç®„É©„Éº:", error);
    res.status(500).json({ error: "„Éá„Éº„ÇøÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü" });
  }
});

app.delete('/api/expansions/:id', async (req, res) => {
  const { id } = req.params;

  const sql = 'DELETE FROM expansions WHERE id = ?';

  try {
    const [result] = await pool.query(sql, [id]);

    if (result.affectedRows === 0) {
      return res.status(404).json({ message: 'ÂØæË±°„ÅÆÂ¢óÂ∫äË®òÈå≤„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' });
    }

    res.status(200).json({ message: 'Â¢óÂ∫äË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü' });
  } catch (err) {
    console.error('Â¢óÂ∫äÂâäÈô§„Ç®„É©„Éº:', err);
    res.status(500).json({ message: 'ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

app.post('/api/expansions', async (req, res) => {
  console.log("POST /api/expansions „ÅåÂëº„Å∞„Çå„Åæ„Åó„ÅüÔºÅ");
  console.log("req.body:", req.body);

  const {
    propertyName,
    unitName,
    expansionType,
    newRooms,
    commonRoom,
    startDate
  } = req.body;

  const sql = `
    INSERT INTO expansions (
      property_name,
      unit_name,
      expansion_type,
      new_rooms,
      common_room,
      start_date
    ) VALUES (?, ?, ?, ?, ?, ?)
  `;

  const values = [
    propertyName || null,
    unitName || null,
    expansionType || null,
    JSON.stringify(newRooms || []),  // TEXTÂûã„Å®„Åó„Å¶‰øùÂ≠ò
    commonRoom || null,
    startDate || null
  ];

  try {
    const [result] = await pool.query(sql, values);
    res.status(201).json({ message: 'Â¢óÂ∫äÊÉÖÂ†±„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü', id: result.insertId });
  } catch (err) {
    console.error('Â¢óÂ∫äÁôªÈå≤„Ç®„É©„Éº:', err);
    res.status(500).json({ message: 'Â¢óÂ∫äÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

// =======================
// üåê Ë£úÂä© API
// =======================
app.get('/api/my-ip', async (req, res) => {
  const fetch = (await import('node-fetch')).default;
  const response = await fetch('https://api.ipify.org?format=json');
  const data = await response.json();
  res.json(data);
});

// =======================
// üì¶ „Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„É´„Éº„Éà
// =======================
app.use(express.static(path.join(__dirname, 'dist')));
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'dist', 'index.html'));
});

app.listen(PORT, () => {
  console.log(`üöÄ Server is running on port ${PORT}`);
});

